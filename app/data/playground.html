<!DOCTYPE html>
<html>
    <head>
        <title>London</title>
    </head>
    </body>
        <button onclick="getLiveData()">Get Live</button>
        <!--<script src="//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>-->
        <script type="text/javascript">
            var data = [{"$type":"Tfl.Api.Presentation.Entities.Prediction, Tfl.Api.Presentation.Entities","id":"-1230210341","operationType":1,"vehicleId":"026","naptanId":"940GZZLUBND","stationName":"Bond Street Underground Station","lineId":"central","lineName":"Central","platformName":"Eastbound - Platform 2","direction":"outbound","destinationNaptanId":"940GZZLUEPG","destinationName":"Epping Underground Station","timestamp":"2015-09-04T09:49:11.977Z","timeToStation":418,"currentLocation":"At Notting Hill Gate","towards":"Epping","expectedArrival":"2015-09-04T09:56:09.977Z","timeToLive":"2015-09-04T09:56:09.977Z","modeName":"tube"},{"$type":"Tfl.Api.Presentation.Entities.Prediction, Tfl.Api.Presentation.Entities","id":"334938528","operationType":1,"vehicleId":"066","naptanId":"940GZZLUBKE","stationName":"Barkingside Underground Station","lineId":"central","lineName":"Central","platformName":"Inner Rail - Platform 2","direction":"outbound","destinationNaptanId":"940GZZLUHLT","destinationName":"Hainault Underground Station","timestamp":"2015-09-04T09:49:11.68Z","timeToStation":298,"currentLocation":"Between Redbridge and Gants Hill","towards":"Hainault via Newbury Park","expectedArrival":"2015-09-04T09:54:09.68Z","timeToLive":"2015-09-04T09:54:09.68Z","modeName":"tube"},{"$type":"Tfl.Api.Presentation.Entities.Prediction, Tfl.Api.Presentation.Entities","id":"-1019785503","operationType":1,"vehicleId":"113","naptanId":"940GZZLULYN","stationName":"Leyton Underground Station","lineId":"central","lineName":"Central","platformName":"Eastbound - Platform 2","direction":"inbound","destinationNaptanId":"940GZZLULVT","destinationName":"Liverpool Street Underground Station","timestamp":"2015-09-04T09:49:13.383Z","timeToStation":267,"currentLocation":"Between Mile End and Stratford","towards":"Loughton","expectedArrival":"2015-09-04T09:53:40.383Z","timeToLive":"2015-09-04T09:53:40.383Z","modeName":"tube"}];
            var routes = {
                "central": [
                    ["WRP","RSG","SRP","NHT","GFD","PVL","HGR","NAN","EAN","WCY","SBC","HPK","NHG","QWY","LGT","MBA","BND","OXC","TCR","HBN","CHL","SPU","BNK","LVT","BLG","MED","STD","LYN","LYS","SNB","SWF","WOF","BKH","LGN","DBN","THB","EPG"],
                    ["WRP","RSG","SRP","NHT","GFD","PVL","HGR","NAN","EAN","WCY","SBC","HPK","NHG","QWY","LGT","MBA","BND","OXC","TCR","HBN","CHL","SPU","BNK","LVT","BLG","MED","STD","LYN","LYS","WSD","RBG","GTH","NBP","BKE","FLP","HLT","GGH","CWL","RVY","WOF"],
                    ["EBY","WTA","NAN","EAN","WCY","SBC","HPK","NHG","QWY","LGT","MBA","BND","OXC","TCR","HBN","CHL","SPU","BNK","LVT","BLG","MED","STD","LYN","LYS","SNB","SWF","WOF","BKH","LGN","DBN","THB","EPG"],
                    ["EBY","WTA","NAN","EAN","WCY","SBC","HPK","NHG","QWY","LGT","MBA","BND","OXC","TCR","HBN","CHL","SPU","BNK","LVT","BLG","MED","STD","LYN","LYS","WSD","RBG","GTH","NBP","BKE","FLP","HLT","GGH","CWL","RVY","WOF"]
                ]
            }

            var lines = {
                "bakerloo": {
                    "stops": [
                        ["EAC","LBN","WLO","EMB","CHX","PCC","OXC","RGP","BST","MYB","ERB","PAC","WKA","MVL","KPK","QPS","KSL","WJN","HSN","SGP","WYC","NWY","SKT","KEN","HAW"]
                    ],
                    "colour": "#AE6118"
                },
                "central": {
                    "stops": [
                        ["EAN","WCY","SBC","HPK","NHG","QWY","LGT","MBA","BND","OXC","TCR","HBN","CHL","SPU","BNK","LVT","BLG","MED","STD","LYN"],
                        ["WSD","RBG","GTH","NBP","BKE","FLP","HLT","GGH","CWL","RVY","WOF"],
                        ["SNB","SWF","WOF","BKH","LGN","DBN","THB","EPG"],
                        ["WRP","RSG","SRP","NHT","GFD","PVL","HGR"],
                        ["EBY","WTA"],
                        ["LYS"],
                        ["NAN"]
                    ],
                    "routes": [
                        [3,6,0,5,1],
                        [3,6,0,5,2],
                        [4,6,0,5,1],
                        [4,6,0,5,2]
                    ],
                    "paths": [
                        [5,0,6],
                        [1,5],
                        [2,5],
                        [3,6],
                        [4,6]
                    ],
                    "colour": '#E41F1F'
                },
                "circle": {
                    "stops": [
                        ["HSC","GHK","SBM","WLA","LRD","LAD","WSP","RYO","PAH","ERC","BST","GPS","ESQ","KSX","FCN","BBN","MGT","LVT","ALD","TWH","MMT","CST","MSH","BKF","TMP","EMB","WSM","SJP","VIC","SSQ","SKS","GTR","HSK","NHG","BWT","PAC","ERC"]
                    ],
                    "colour": "#F8D42D"
                },
                "district": {
                    "stops": [
                        ["GTR","SKS","SSQ","VIC","SJP","WSM","EMB","TMP","BKF","MSH","CST","MMT","TWH","ADE","WPL","SGN","MED","BWR","BBB","WHM","PLW","UPK","EHM","BKG","UPY","BEC","DGY","DGE","EPK","HCH","UPB","UPM"],
                        ["WIM","WIP","SFS","EPY","PYB","PSG","FBY","WBN"],
                        ["SFB","RVP","HSD","BSC","WKN"],
                        ["HSK","NHG","BWT","PAC","ERC"],
                        ["EBY","ECM","ACT","CWP"],
                        ["RMD","KWG","GBY"],
                        ["KOY"],
                        ["ECT"],
                        ["TNG"]
                    ],
                    "routes": [
                        [4,8,2,7,0],
                        [4,8,2,7,3],
                        [5,8,2,7,0],
                        [5,8,2,7,3],
                        [1,7,0],
                        [1,7,3],
                        [6,7,0],
                        [6,7,3],
                    ],
                    "paths": [
                        [8,2,7],
                        [4,8],
                        [5,8],
                        [1,7],
                        [7,3],
                        [6,7],
                        [7,0]
                    ],
                    "colour": "#007229"
                },
                "hammersmith-city": {
                    "stops": [
                        ["HSC","GHK","SBM","WLA","LRD","LAD","WSP","RYO","PAH","ERC","BST","GPS","ESQ","KSX","FCN","BBN","MGT","LVT","ADE","WPL","SGN","MED","BWR","BBB","WHM","PLW","UPK","EHM","BKG"]
                    ],
                    "colour": "#E899A8"
                },
                "jubilee": {
                    "stops": [
                        ["STM","CPK","QBY","KBY","WYP","NDN","DOH","WIG","KBN","WHP","FYR","SWC","SJW","BST","BND","GPK","WSM","WLO","SWK","LNB","BMY","CWR","CYF","NGW","CGT","WHM","STD"]
                    ],
                    "colour": "#686E72"
                },
                "metropolitan": {
                    "stops": [
                        ["ALD","LVT","MGT","BBN","FCN","KSX","ESQ","GPS","BST","FYR","WYP","PRD","NKP"],
                        ["WHW","RYL","EAE","RSM","RSP","ICK","HGD","UXB"],
                        ["NHA","PNR","NWH","NOW"],
                        ["CXY","WAF"],
                        ["RKW","CYD"],
                        ["CSM"],
                        ["AMS"],
                        ["MPK"],
                        ["HOH"],
                        ["CAL"]
                    ],
                    "routes": [
                        [0,8,2,7,4,9,6],
                        [0,8,2,7,4,9,5],
                        [0,8,2,7,3],
                        [0,8,1]
                    ],
                    "paths": [
                        [0,8],
                        [8,1],
                        [8,2,7],
                        [7,3],
                        [7,4,9],
                        [9,5],
                        [9,6]
                    ],
                    "colour": "#893267"
                },
                "northern": {
                    "stops": [
                        ["MDN","SWN","CSD","TBY","TBC","BLM","CPS","CPC","CPN","SKW","OVL"],
                        ["CFM","BZP","HTD","GGN","BTX","HCL","CND","BTK","EGW"],
                        ["EAC","BOR","LNB","BNK","MGT","ODS","AGL","KSX"],
                        ["WLO","EMB","CHX","LSQ","TCR","GDG","WRR"],
                        ["KSH","TFP","ACY","HGT","EFY"],
                        ["WFN","WOP","TAW","HBT"],
                        ["KNG"],
                        ["EUS"],
                        ["MTC"],
                        ["CTN"],
                        ["FYC"],
                        ["MHL"]
                    ],
                    "routes": [
                        [0,6,3,7,8,9,1],
                        [0,6,3,7,8,9,4,10,11],
                        [0,6,3,7,8,9,4,10,5],
                        [0,6,3,7,9,1],
                        [0,6,3,7,9,4,10,11],
                        [0,6,3,7,9,4,10,5]
                    ],
                    "colour": "#000000"
                },
                "victoria": {
                    "stops": [
                        ["BXN","SKW","VXL","PCO","VIC","GPK","OXC","WRR","EUS","KSX","HAI","FPK","SVS","TMH","BLR","WWL"]
                    ],
                    "colour": "#009FE0"
                },
                "waterloo-city": {
                    "stops": [
                        ["WLO","BNK"]
                    ],
                    "colour": "#70C3CE"
                }
            }

            function buildRoute(lineId) {
                var line = lines[lineId];
                var stops = line['stops'];
                var routesToBuild = line['routes'];
                if (!routesToBuild) {
                    return stops;
                }
                var routes = [];
                var route, i, j, iLen, jLen;
                iLen = routesToBuild.length;
                for (i=0; i<iLen; i++) {
                    route = routesToBuild[i];
                    jLen = route.length;
                    for (j=0; j<jLen; j++) {
                        if (routes[i]) {
                            routes[i] = routes[i].concat(stops[route[j]]);
                        } else {
                            routes[i] = stops[route[j]];
                        }
                    }
                }
                return routes;
            }
            console.log(buildRoute('northern'));

            /*function routeChecker(line, sidArr) {
                var i, j, routeArr, routeLen, sidLen;
                routeArr = routes[line];
                routeLen = routeArr.length;
                sidLen = sidArr.length;

                var rtnObj = {};

                for (i=0; i<routeLen; i++) {
                    for (j=0; j<sidLen; j++) {
                        var sidIndex = routeArr[i].indexOf(sidArr[j]);
                        if (sidIndex === -1) {
                            rtnObj = {};
                            break;
                        } else {
                            rtnObj[j] = sidIndex;
                            if (j === sidLen-1) {
                                rtnObj['route'] = routeArr[i];
                                return rtnObj;
                            }
                        }
                    }
                }
                return false;
            }*/
            function between(a, b, c) {
                if (a > b) {
                    if (c <= a && c >= b) {
                        return true;
                    }
                } else {
                    if (c <= b && c >= a) {
                        return true;
                    }
                }
                return false;
            }

            /*for (var p=0; p<data.length; p++) {
                var d = data[p];
                var line = d['lineId'];
                var a = d['naptanId'].substring(8); // Train will definitly be here *** Change to current location - should be 
                var b = d['destinationNaptanId'].substring(8); // Train heading here
                var c = 'LVT'; // Caller - will the train be here?

                var route = routeChecker(line, [a, b, c]);
                if (route) {
                    var check = between(route[0],route[1],route[2]);
                    if (check) {
                        console.log('Yes');
                    } else {
                        console.log('No');
                    }
                } else {
                    console.log('No');
                }
                console.log(a + ' - ' + b + ' - ' + c);
            }*/

            //buildRoute('EBY', 'BKE');

            /*var line = routes['central'];
            var caller = 'BKE';
            var train = 'STD';
            var terminus = 'HLT';
            var via = 'NBP';

            if (caller === terminus || caller === train || caller === via) {
                return true;
            }*/

            //console.log(routes);
            //var sObj = {sid:{},sidLookup:{}} = stationData.min.js
            /*var stnObj = {};
            var endPoints = {
                'central': ['HLT','EPG','EBY','WRP'],
                'bakerloo': ['HAW','EAC'],
                'central': ['HLT','EPG','EBY','WRP'],
                'circle': ['HSC'],
                'district': ['UPM','RMD','WIM','ERC','KOY'],
                'hammersmith-city': ['HSC','BKG'],
                'jubilee': ['STM','STD'],
                'metropolitan': ['ALD','UXB','CSM','AMS'],
                'northern': ['MDN','HBT','EGW','MHL'],
                'piccadilly': ['CKS','UXB','HR5'],
                'victoria': ['WWL','BXN'],
                'waterloo-city': ['BNK','WLO']
            };

            var validRoutes = {"bakerloo":{"inbound":{"HAW":["EAC"]},"outbound":{"EAC":["HAW"]}},"central":{"inbound":{"HLT":["WRP","EBY"],"EPG":["WRP","EBY"]},"outbound":{"WRP":["HLT","EPG"],"EBY":["HLT","EPG"]}},"district":{"inbound":{"UPM":["WIM","EBY","RMD"],"ERC":["WIM","KOY","EBY","RMD"]},"outbound":{"WIM":["UPM","ERC"],"KOY":["UPM","ERC"],"EBY":["UPM","ERC"],"RMD":["UPM","ERC"]}},"hammersmith-city":{"inbound":{"BKG":["HSC"]},"outbound":{"HSC":["BKG"]}},"jubilee":{"inbound":{"STD":["STM"]},"outbound":{"STM":["STD"]}},"metropolitan":{"inbound":{"ALD":["UXB","WAF","AMS","CSM"],"WAF":["RKW"]},"outbound":{"UXB":["ALD"],"CSM":["WAF","ALD"],"WAF":["ALD"],"AMS":["ALD"]}},"northern":{"inbound":{"EGW":["MDN"],"HBT":["MDN"],"MHL":["MDN"]},"outbound":{"MDN":["EGW","HBT","MHL"]}},"piccadilly":{"inbound":{"CKS":["UXB","HRC","HR5"]},"outbound":{"UXB":["CKS"],"HR5":["CKS"],"HR4":["CKS"]}},"victoria":{"inbound":{"WWL":["BXN"]},"outbound":{"BXN":["WWL"]}},"waterloo-city":{"inbound":{"BNK":["WLO"]},"outbound":{"WLO":["BNK"]}},"circle":{"inbound":{"ERC":["HSC"]},"outbound":{"HSC":["ERC"]}}};

            var boundObj = {
                'central': {
                    'inbound': ['westbound'],
                    'outbound': ['eastbound']
                },
                'bakerloo': {
                    'inbound': ['southbound'],
                    'outbound': ['northbound']
                },
                'district': {
                    'inbound': ['westbound'],
                    'outbound': ['eastbound']
                },
                'hammersmith-city': {
                    'inbound': ['westbound', 'southbound'],
                    'outbound': ['northbound', 'eastbound']
                },
                'jubilee': {
                    'inbound': ['westbound', 'northbound'],
                    'outbound': ['eastbound', 'southbound']
                },
                'metropolitan': {
                    'outbound': ['eastbound', 'southbound'],
                    'inbound': ['westbound','northbound']
                },
                'northern': {
                    'inbound': ['southbound'],
                    'outbound': ['northbound']
                },
                'piccadilly': {
                    'inbound': ['westbound'],
                    'outbound': ['eastbound']
                },
                'victoria': {
                    'inbound': ['southbound'],
                    'outbound': ['northbound']
                },
                'waterloo-city': {
                    'inbound': ['eastbound'],
                    'outbound': ['westbound']
                },
                'circle': {
                    'inbound':['westbound', 'southbound'],
                    'outbound':['eastbound', 'northbound']
                }
            };

            function theEnd() {
                var terminus = {};
                for (var stn in sObj['sid']) {
                    var station = sObj['sid'][stn];
                    var lines = station['line'];
                    //console.log(lines);
                    for (line in lines) {
                        var platforms = lines[line];
                        //for (var platform in platforms) {
                            if (Object.keys(platforms).length === 1) {
                                //console.log(station);
                                for (var platform in platforms) {
                                    var keyName = stn+line;
                                    terminus[keyName] = platform;
                                }
                            }
                        //}
                    }
                }
                console.log(JSON.stringify(terminus));
            }

            var dataObj = {};
            function compassBound() {
                //Get valie routes
                for (var line in validRoutes) {
                    $.ajax({
                        url: 'https://api.tfl.gov.uk/Line/%7Bid%7D/Route/Sequence/%7Bdirection%7D',
                        type: 'GET',
                        data: {
                            id: line
                        },
                        async: false
                    }).done(function (data) {
                        
                        var routesObj = data['orderedLineRoutes'];
                        for (var k=0; k<2; k++) {
                            for (var key in routesObj) {
                                var routesArr = routesObj[key]['naptanIds'];
                                if (k) routesArr.reverse();
                                var routeLen = routesArr.length;
                                var origin = routesArr[0].substring(8);

                                var bound = 'inbound';
                                if (validRoutes[line]['outbound'][origin]) {
                                    bound = 'outbound';
                                }

                                for (var i=0; i<routeLen; i++) {
                                    var sid = routesArr[i].substring(8);
                                    var possDirectionArr = boundObj[line][bound];
                                    var actDirectionArr = sObj['sid'][sid]['lines'][line];
                                    var direction = null;
                                    for (var j=0; j<possDirectionArr.length; j++) {
                                        if (actDirectionArr.indexOf(possDirectionArr[j]) > -1) {
                                            direction = boundObj[line][bound][j];
                                        } else {

                                        }
                                    }
                                    var nid = null;
                                    if (i<routeLen-1) {
                                        nid = routesArr[i+1].substring(8);
                                    }
                                    if (nid) {
                                        if (!dataObj[sid]) dataObj[sid] = {};
                                        if (!dataObj[sid][line]) dataObj[sid][line] = {};
                                        if (!direction) {
                                            console.log(line + '-> ' + sid + '-' + nid + ' s:' + possDirectionArr + ' sObj:' + actDirectionArr);
                                            continue;
                                        }
                                        if (!dataObj[sid][line][direction]) dataObj[sid][line][direction] = {};
                                        if (!dataObj[sid][line][direction][nid]) {
                                            dataObj[sid][line][direction][nid] = sObj['sid'][sid]['route'][nid];
                                        }
                                    }
                                }
                                
                            }
                        }
                    });
                }
                console.log(dataObj);
            }

            function mergeData() {
                for (var key in routeObj) {
                    for (var adj in routeObj[key]) {
                        if (!stationsObj[key]['route']) {
                            stationsObj[key]['route'] = {};
                        }
                        stationsObj[key]['route'][adj] = key;
                    } 
                }
                console.log(stationsObj);
            }

            function getLiveData() {
                var line, sid;

                for (line in endPoints) {
                    for (sid in endPoints[line]) {
                        $.ajax({
                            url: 'https://api.tfl.gov.uk/Line/%7Bid%7D/Timetable/%7BfromStopPointId%7D',
                            type: 'GET',
                            data: { 
                                fromStopPointId: "940GZZLU"+endPoints[line][sid],
                                id: line
                            }
                        }).done(function (data) {
                            var i;
                            var dataArr = data.timetable.routes[0].stationIntervals;
                            var dataLen = dataArr.length;
                            for (i=0; i<dataLen; i++) {
                                process(dataArr[i].intervals);
                            }
                        });
                    }
                }
            }

            function process(data) {

                var dataLen = data.length;
                var i,
                    sid, // This station id
                    pid, // Previous station id
                    nid, // Next station id
                    ttp, // Time to previous station
                    ttn; // Time to next station

                for (i = 0; i < dataLen; i++) {

                    sid = data[i]['stopId'].substring(8);
                   
                    // Check if station exists in station object. If not, create it.
                    if (!stnObj[sid]) {
                        stnObj[sid] = {};
                    }

                    // Has a previous station
                    if (i) {
                        pid = data[i-1]['stopId'].substring(8);
                        ttp = Math.round((data[i]['timeToArrival']-data[i-1]['timeToArrival'])*10)/10;
                        if (stnObj[sid][pid]) {
                            stnObj[sid][pid].push(ttp);
                        } else {
                            stnObj[sid][pid] = [ttp];
                        }
                    }

                    // Has a next station
                    if (i < dataLen-1) {
                        nid = data[i+1]['stopId'].substring(8);
                        ttn = Math.round((data[i+1]['timeToArrival']-data[i]['timeToArrival'])*10)/10;
                        if (stnObj[sid][nid]) {
                            stnObj[sid][nid].push(ttn);
                        } else {
                            stnObj[sid][nid] = [ttn];
                        }
                    }

                }
            }

            function logData() {
                var i, stn, adj, total;
                for (stn in stnObj) {
                    for (adj in stnObj[stn]) {
                        total = 0;
                        var adjLen = stnObj[stn][adj].length;
                        for (i=0; i<adjLen; i++) {
                            total += stnObj[stn][adj][i];
                        }
                        stnObj[stn][adj] = Math.round((total/adjLen)*60);
                    }
                }
                console.log(stnObj);
            }*/
        </script>
    </body>
</html>